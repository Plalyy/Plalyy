# Database

为什么存储引擎要设计成可插拔式

缓存穿透、缓存雪崩、缓存击穿

为什么主键推荐自增id？答了直接插到链表尾部，还有别的吗？原来是想让我答页分裂。

单机的QPS可能到达几十W就很高了，那么如何突破这个瓶颈（分布式相关的）

## MVCC

- 多版本并发控制，常用处理读写冲突，提高数据库高并发场景吞吐能力
- 不同的事务在并发过程中，SELECT 操作可以不加锁而是通过 MVCC 机制读取指定的版本历史记录，并通过一些手段保证保证读取的记录值符合事务所处的隔离级别，从而解决并发场景下的读写冲突。

## 乐观锁和悲观锁

- 悲观锁：基于悲观，防止一切数据冲突，释放锁之前任何人都不能对其数据进行操作，数据库本身锁的机制都是基于悲观锁的机制实现的;
- 乐观锁：乐观态度，不会加锁，数据提交的时候才通过一种机制来验证数据是否存在冲突(一般实现方式是通过加版本号然后进行版本号的对比方式实现)

为什么B+树作为索引，B树索引呢，为什么不建议用Hash作索引结构

## 用户id生成
- 自增ID
  - 优点：插入有序，innodb引擎下，查询、插入速度快，占用空间小
  - 缺点：多表合并和数据迁移会有id冲突
- UUID
  - 优点：唯一id不会冲突
  - 缺点：占用空间大，插入和查询速度慢
- 雪花算法：分布式id生成，使用一个 64 bit 的 long 型的数字作为全局唯一 id，ID 引入了时间戳，基本上保持自增

怎么保证DB里面的数据不会被修改（权限问题不考虑，假设用户有权限）？

## MySQL锁，粒度和开销

- 在关系型数据库中，可以按照锁的粒度把数据库锁分为行级锁(INNODB引擎)、表级锁(MYISAM引擎)和页级锁(BDB引擎 )
- 行级锁
    - 1.行级锁是MySQL中锁定粒度最细的一种锁，表示只针对当前操作的行进行加锁。行级锁能大大减少数据库操作的冲突。其加锁粒度最小，但加锁的开销也最大。行级锁分为共享锁 和 排他锁。
    - 2.开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。
- 表级锁
    - 1.表级锁是MySQL中锁定粒度最大的一种锁，表示对当前操作的整张表加锁，它实现简单，资源消耗较少，被大部分MySQL引擎支持。最常使用的MYISAM与INNODB都支持表级锁定。表级锁定分为表共享读锁（共享锁）与表独占写锁（排他锁）。
    - 2.开销小，加锁快；不会出现死锁；锁定粒度大，发出锁冲突的概率最高，并发度最低。
- 页级锁
    - 1.页级锁是MySQL中锁定粒度介于行级锁和表级锁中间的一种锁。表级锁速度快，但冲突多，行级冲突少，但速度慢。所以取了折衷的页级，一次锁定相邻的一组记录。BDB支持页级锁
    - 2.开销和加锁时间界于表锁和行锁之间；会出现死锁；锁定粒度界于表锁和行锁之间，并发度一般
        - MyISAM和InnoDB存储引擎使用的锁：
        - MyISAM采用表级锁(table-level locking)。
        - InnoDB支持行级锁(row-level locking)和表级锁，默认为行级锁

## 外键
- 保持数据一致性、完整性，主要控制存储在外键表中的数据，使两张表形成关联。

【todo】锁

## ACID

事务是访问和更新数据库的程序执行单元。

- 原子性（Atomicity，或称不可分割性）：原子性是指一个事务是一个不可分割的工作单位，其中的操作要么都做，要么都不做；如果事务中一个sql语句执行失败，则已执行的语句也必须回滚，数据库退回到事务前的状态。

- 一致性（Consistency）：数据库总是从一个一致性的状态转换到另外一个一致性状态，不会部分数据状态改变了部分状态没有改变。

- 隔离性（Isolation）：事务内部的操作与其他事务是隔离的，并发执行的各个事务之间不能互相干扰。

- 持久性（Durability）：持久性是指事务一旦提交，它对数据库的改变就应该是永久性的。接下来的其他操作或故障不应该对其有任何影响。

## 索引

- 主键索引：设定为主键后数据库会自动建立索引，innodb为聚簇索引
- 单值索引：一个索引只包含单个列，一个表可以有多个单列索引：CREATE INDEX idx_customer_name ON customer(customer_name)
- 唯一索引：索引列的值必须唯一，但允许有空值：CREATE UNIQUE INDEX idx_customer_no ON customer(customer_no)， 主键自动建立唯一索引
- 复合索引：即一个索引包含多个列，在数据库操作期间，复合索引比单值索引所需要的开销更小(对于相同的多个列建索引)，当表的行数远大于索引列的数目时可以使用复合索引

【todo】innodb和myisam

- InnoDB支持事务，存在并发事务问题：
  - 更新丢失：多事务同时更新一个数据
  - 脏读：事务处理过程中读取了另一个事务未提交的数据
  - 不可重复读：事务多次查询数据，得到不同结果
  - 幻读：原位置被插入数据，幻读

innodb中主键索引和非主键索引都是聚簇索引吗

主键索引是聚簇索引，非主键索引不是聚簇索引，因为非主键索引的叶子节点只会存主键和index，所以会有索引下推，索引覆盖，回表。

事务

事务回滚的实现

mysql主从架构

- 多数据库，主从复制方式同步数据
  - 主丛夫

mysql双主架构在不分表的情况下保证数据一致性

pc两阶段提交

如何避免mysql双主架构出现会循环的数据更新

使用一个标志位，来标记请求的来源，如果是来自用户则执行后广播至其他主节点，如果来自其他主节点则执行。